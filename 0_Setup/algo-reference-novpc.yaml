Description: >
  This template deploys the algorithmic trading reference architecture
  
Parameters:
  EnvironmentName:
    Description: An environment name that will be prefixed to resource names
    Type: String
    Default: algo

  S3Bucket:
    Description: Please specify your S3 bucket
    Type: String
    
Resources:

  ECR:
    Type: AWS::ECR::Repository
    Properties: 
      RepositoryName: !Sub ${EnvironmentName}_ecr
    
  AlgorithmicTradingInstance:
    Type: AWS::SageMaker::NotebookInstance
    Properties:
      InstanceType: ml.t3.large
      DefaultCodeRepository: https://bitbucket.org/imalinovsky/algorithmic-trading
      RoleArn: !GetAtt 'SageMakerExecutionRole.Arn'
      PlatformIdentifier: notebook-al2-v3

  S3Policy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: S3 Permission
      Path: /
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !Sub
                - arn:aws:s3:::${S3Bucket}/*
                - S3Bucket: !Ref 'S3Bucket'
                
  SageMakerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - sagemaker.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess
        - arn:aws:iam::aws:policy/AmazonAthenaFullAccess
        - arn:aws:iam::aws:policy/AWSCloudFormationReadOnlyAccess 
        - arn:aws:iam::aws:policy/AmazonECS_FullAccess
        - arn:aws:iam::aws:policy/AmazonKinesisReadOnlyAccess
        - !Ref 'S3Policy'

  
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
              
  AlgoExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
  
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
        ClusterName: !Ref EnvironmentName
        
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
        CatalogId: !Ref 'AWS::AccountId'
        DatabaseInput:
          Name: algo_data

  GlueHistDataDaily:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref 'GlueDatabase'
      TableInput:
        Description: Daily Price Data
        Name: hist_data_daily
        Parameters:
          classification: csv
          has_encrypted_data: false
        StorageDescriptor:
          Columns:
            - Name: dt
              Type: string
            - Name: sym
              Type: string
            - Name: open
              Type: double
            - Name: high
              Type: double
            - Name: low
              Type: double
            - Name: close
              Type: double
            - Name: vol
              Type: double
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref 'S3Bucket'
              - /hist_data_daily
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
            Parameters:
              field.delim: ','
              skip.header.line.count: '1'
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  GlueHistDataIntraday:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref 'GlueDatabase'
      TableInput:
        Description: Intraday Price Data
        Name: hist_data_intraday
        Parameters:
          classification: csv
          has_encrypted_data: false
        StorageDescriptor:
          Columns:
            - Name: dt
              Type: string
            - Name: sym
              Type: string
            - Name: open
              Type: double
            - Name: high
              Type: double
            - Name: low
              Type: double
            - Name: close
              Type: double
            - Name: vol
              Type: double
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref 'S3Bucket'
              - /hist_data_intraday
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
            Parameters:
              field.delim: ','
              skip.header.line.count: '1'
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE
  
  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: MyWorkGroup
      Description: AlgoWorkgroup
      RecursiveDeleteOption: true
      State: ENABLED
      WorkGroupConfiguration:
        RequesterPaysEnabled: true
        ResultConfiguration:
          OutputLocation: !Join
            - ''
            - - s3://
              - !Ref 'S3Bucket'
              - /results/

  AlgoHistDataDaily:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database: !Ref 'GlueDatabase'
      QueryString: !Join
        - ''
        - - select * from algo_data.
          - !Ref 'GlueHistDataDaily'
          - ' limit 10;'
      Name: HistDataDaily

  AlgoHistDataIntraday:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database: !Ref 'GlueDatabase'
      QueryString: !Join
        - ''
        - - select * from algo_data.
          - !Ref 'GlueHistDataIntraday'
          - ' limit 10;'
      Name: HistDataIntraday

  GlueTableFeedDB:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseName: !Ref 'GlueDatabase'
      TableInput:
        Description: Deutsche Boerse Xetra PDS
        Name: market_feed_deutsche_boerse
        Parameters:
          classification: csv
          has_encrypted_data: false
        StorageDescriptor:
          Columns:
            - Name: isin
              Type: string
            - Name: mnemonic
              Type: string
            - Name: securitydesc
              Type: string
            - Name: securitytype
              Type: string
            - Name: currency
              Type: string
            - Name: securityid
              Type: bigint
            - Name: date
              Type: string
            - Name: time
              Type: string
            - Name: startprice
              Type: double
            - Name: maxprice
              Type: double
            - Name: minprice
              Type: double
            - Name: endprice
              Type: double
            - Name: tradedvolume
              Type: bigint
            - Name: numberoftrades
              Type: bigint
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref 'S3Bucket'
              - /feed/deutsche-boerse-xetra-pds
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
            Parameters:
              field.delim: ','
              skip.header.line.count: '1'
          StoredAsSubDirectories: false
        PartitionKeys:
            - Name: year
              Type: bigint
            - Name: month
              Type: bigint
            - Name: day
              Type: bigint       
        TableType: EXTERNAL_TABLE
  
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties: 
      LogGroupName: algo
      RetentionInDays: 7

Outputs:

  ECR:
    Description: A reference to ECR
    Value: !Ref ECR
    Export:
      Name: AlgorithmicTrading-ECR

  S3Bucket:
    Description: A reference to S3 Bucket
    Value: !Ref S3Bucket
    Export:
      Name: AlgorithmicTrading-S3Bucket


  ECSTaskExecutionRole:
    Description: ECSTaskExecutionRole
    Value: !Ref ECSTaskExecutionRole
    Export:
      Name: AlgorithmicTrading-ECSTaskExecutionRole

  AlgoExecutionRole:
    Description: AlgoExecutionRole ARN
    Value: !GetAtt 'AlgoExecutionRole.Arn'
    Export:
      Name: AlgorithmicTrading-AlgoExecutionRole-ARN

  Cluster:
    Description: A reference to the ECS cluster
    Value: !Ref ECSCluster
    Export:
      Name: AlgorithmicTrading-ECSCluster
